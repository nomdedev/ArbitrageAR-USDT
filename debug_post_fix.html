<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîç Debug: Verificaci√≥n Post-Fix v5.0.35</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      margin: 15px 0;
    }
    .warning {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin: 15px 0;
    }
    .error {
      background: #f8d7da;
      border-left: 4px solid #dc3545;
      padding: 15px;
      margin: 15px 0;
    }
    .success {
      background: #d1e7dd;
      border-left: 4px solid #198754;
      padding: 15px;
      margin: 15px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .selected {
      background-color: #e8f5e8 !important;
    }
    button {
      background: #2196f3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 0;
    }
    button:hover {
      background: #1976d2;
    }
    .price {
      font-weight: bold;
      color: #2e7d32;
    }
  </style>
</head>
<body>
  <h1>üîç Debug Post-Fix v5.0.35: Verificaci√≥n de Mapeo API</h1>

  <div class="container">
    <h2>üìã Estado del Fix</h2>
    <div class="success">
      <h3>‚úÖ FIX APLICADO v5.0.35</h3>
      <p><strong>Problema anterior:</strong> Est√°bamos usando quote.buy (precio bajo) para "compra"</p>
      <p><strong>Soluci√≥n aplicada:</strong> Ahora usamos quote.sell (precio alto) para "compra"</p>
      <p><strong>Archivos modificados:</strong> DataService.js, ScrapingService.js</p>
    </div>
  </div>

  <button onclick="verificarFix()">‚ñ∂Ô∏è Verificar Fix y Datos Actuales</button>

  <div id="resultado"></div>

  <script>
    async function verificarFix() {
      const output = document.getElementById('resultado');
      output.innerHTML = '<div class="info-box"><p>‚è≥ Verificando fix y obteniendo datos actuales...</p></div>';

      try {
        // 1. Obtener datos RAW de la API
        const response = await fetch('https://www.dolarito.ar/cotizacion/bancos');
        const htmlText = await response.text();
        const jsonMatch = htmlText.match(/"bankQuotations":\s*({[^}]*"quotations":\s*\[[^\]]*\][^}]*})/);

        if (!jsonMatch) {
          output.innerHTML = '<div class="error"><p>‚ùå No se pudieron obtener datos de dolarito.ar</p></div>';
          return;
        }

        const bankData = JSON.parse(`{${jsonMatch[1]}}`);
        const quotations = bankData.quotations || [];

        let html = '<div class="container">';
        html += '<h2>üìä Datos RAW de la API (Actuales)</h2>';
        html += '<p>Primeros 3 bancos para verificar estructura:</p>';
        html += '<pre>' + JSON.stringify(quotations.slice(0, 3), null, 2) + '</pre>';
        html += '</div>';

        // Mapeo de c√≥digos de bancos
        const getBankCode = (fullName) => {
          const bankCodes = {
            'Banco Naci√≥n': 'nacion',
            'BBVA Banco Franc√©s': 'bbva',
            'BBVA': 'bbva',
            'Banco Piano': 'piano',
            'Banco Hipotecario': 'hipotecario',
            'Banco Galicia': 'galicia',
            'Banco Santander R√≠o': 'santander',
            'Banco Santander': 'santander',
            'Banco Ciudad': 'ciudad',
            'Banco Supervielle': 'supervielle',
            'Banco Patagonia': 'patagonia',
            'Banco Comafi': 'comafi',
            'ICBC': 'icbc',
            'Bind': 'bind',
            'Bancor': 'bancor',
            'Nuevo Banco del Chaco': 'chaco',
            'Banco Chaco': 'chaco',
            'Banco de la Pampa': 'pampa',
            'Banco Pampa': 'pampa',
            'Banco Provincia': 'provincia',
            'Banco de la Provincia de Buenos Aires': 'provincia',
            'Banco Columbia': 'columbia',
            'Banco Macro': 'macro'
          };
          return bankCodes[fullName] || fullName.toLowerCase().replace(/[^a-z]/g, '');
        };

        // Bancos principales (seg√∫n configuraci√≥n por defecto)
        const bancosSeleccionados = ['nacion', 'galicia', 'santander', 'bbva', 'ciudad'];

        html += '<div class="container">';
        html += '<h2>üè¶ Mapeo de Datos POST-FIX</h2>';
        html += '<p><strong>Bancos seleccionados por defecto:</strong> ' + bancosSeleccionados.join(', ') + '</p>';
        html += '<table>';
        html += '<thead><tr>';
        html += '<th>‚úì</th>';
        html += '<th>Banco</th>';
        html += '<th>C√≥digo</th>';
        html += '<th>quote.buy (API)</th>';
        html += '<th>quote.sell (API)</th>';
        html += '<th>üî¥ ANTES (Incorrecto)</th>';
        html += '<th>üü¢ AHORA (Correcto)</th>';
        html += '</tr></thead>';
        html += '<tbody>';

        const allBanks = [];
        quotations.forEach(quote => {
          const bankName = quote.name?.trim();
          const buyPrice = parseFloat(quote.buy);
          const sellPrice = parseFloat(quote.sell);

          if (bankName && !isNaN(buyPrice) && !isNaN(sellPrice) && buyPrice > 0 && sellPrice > 0) {
            const bankCode = getBankCode(bankName);
            const isSelected = bancosSeleccionados.includes(bankCode);

            // ANTES (incorrecto): compra = buyPrice, venta = sellPrice
            // AHORA (correcto): compra = sellPrice, venta = buyPrice
            const compraAntes = buyPrice;
            const compraAhora = sellPrice;

            allBanks.push({
              code: bankCode,
              name: bankName,
              buy_raw: buyPrice,
              sell_raw: sellPrice,
              compra_antes: compraAntes,
              compra_ahora: compraAhora,
              isSelected: isSelected
            });

            const rowClass = isSelected ? 'selected' : '';
            const checkMark = isSelected ? '‚úÖ' : '‚ùå';

            html += `<tr class="${rowClass}">`;
            html += `<td>${checkMark}</td>`;
            html += `<td>${bankName}</td>`;
            html += `<td><code>${bankCode}</code></td>`;
            html += `<td>$${buyPrice.toFixed(2)}</td>`;
            html += `<td>$${sellPrice.toFixed(2)}</td>`;
            html += `<td><span style="color: red;">$${compraAntes.toFixed(2)}</span></td>`;
            html += `<td><span style="color: green; font-weight: bold;">$${compraAhora.toFixed(2)}</span></td>`;
            html += `</tr>`;
          }
        });

        html += '</tbody></table>';
        html += '</div>';

        // Filtrar solo bancos seleccionados
        const selectedBanks = allBanks.filter(b => b.isSelected);

        html += '<div class="container">';
        html += `<h2>‚úÖ Bancos Seleccionados (${selectedBanks.length}) - POST FIX</h2>`;
        html += '<table>';
        html += '<thead><tr>';
        html += '<th>Banco</th>';
        html += '<th>Compra ANTES (Incorrecto)</th>';
        html += '<th>Compra AHORA (Correcto)</th>';
        html += '<th>Diferencia</th>';
        html += '</tr></thead>';
        html += '<tbody>';

        selectedBanks.forEach(bank => {
          const diff = bank.compra_ahora - bank.compra_antes;
          const diffColor = diff > 0 ? 'green' : 'red';
          html += `<tr class="selected">`;
          html += `<td><strong>${bank.name}</strong></td>`;
          html += `<td><span style="color: red;">$${bank.compra_antes.toFixed(2)}</span></td>`;
          html += `<td><span style="color: green; font-weight: bold;">$${bank.compra_ahora.toFixed(2)}</span></td>`;
          html += `<td><span style="color: ${diffColor};">+$${diff.toFixed(2)}</span></td>`;
          html += `</tr>`;
        });

        html += '</tbody></table>';
        html += '</div>';

        // Calcular CONSENSO con el fix aplicado
        const findConsensusCluster = (banks, tolerance = 0.02) => {
          if (banks.length === 0) return [];

          const sorted = banks.slice().sort((a, b) => a.compra_ahora - b.compra_ahora);
          let bestCluster = [];

          for (let i = 0; i < sorted.length; i++) {
            const center = sorted[i].compra_ahora;
            const cluster = sorted.filter(bank => {
              const diff = Math.abs(bank.compra_ahora - center) / center;
              return diff <= tolerance;
            });

            if (cluster.length > bestCluster.length) {
              bestCluster = cluster;
            }
          }

          return bestCluster;
        };

        const cluster = findConsensusCluster(selectedBanks);
        const consensoAhora = cluster.length > 0
          ? cluster.reduce((sum, bank) => sum + bank.compra_ahora, 0) / cluster.length
          : 0;

        // Calcular consenso ANTES (con el bug)
        const clusterAntes = findConsensusCluster(selectedBanks.map(b => ({...b, compra_ahora: b.compra_antes})));
        const consensoAntes = clusterAntes.length > 0
          ? clusterAntes.reduce((sum, bank) => sum + bank.compra_antes, 0) / clusterAntes.length
          : 0;

        html += '<div class="container">';
        html += '<h2>üéØ Comparaci√≥n de CONSENSO</h2>';
        html += '<table>';
        html += '<tr><td><strong>Consenso ANTES del fix:</strong></td><td style="color: red; font-weight: bold;">$' + consensoAntes.toFixed(2) + '</td></tr>';
        html += '<tr><td><strong>Consenso AHORA con fix:</strong></td><td style="color: green; font-weight: bold;">$' + consensoAhora.toFixed(2) + '</td></tr>';
        html += '<tr><td><strong>Diferencia:</strong></td><td style="color: green; font-weight: bold;">+' + (consensoAhora - consensoAntes).toFixed(2) + '</td></tr>';
        html += '</table>';

        html += '<h3>üìä Detalles del Cluster AHORA</h3>';
        html += `<p><strong>Cluster encontrado:</strong> ${cluster.length} de ${selectedBanks.length} bancos (${Math.round(cluster.length/selectedBanks.length*100)}%)</p>`;
        html += '<table>';
        html += '<thead><tr><th>Banco en Cluster</th><th>Precio COMPRA (Correcto)</th></tr></thead>';
        html += '<tbody>';
        cluster.forEach(bank => {
          html += `<tr style="background: #e8f5e8;">`;
          html += `<td>${bank.name}</td>`;
          html += `<td><strong>$${bank.compra_ahora.toFixed(2)}</strong></td>`;
          html += `</tr>`;
        });
        html += '</tbody></table>';
        html += `<h3 style="color: #2e7d32;">üí∞ PRECIO CONSENSO FINAL: $${consensoAhora.toFixed(2)}</h3>`;
        html += '</div>';

        // Verificaci√≥n del problema reportado
        if (Math.abs(consensoAhora - 1423) < 5) {
          html += '<div class="warning">';
          html += '<h3>‚ö†Ô∏è A√öN HAY PROBLEMA</h3>';
          html += `<p>El consenso corregido da $${consensoAhora.toFixed(2)} pero t√∫ reportas $1423.</p>`;
          html += '<p><strong>Posibles causas:</strong></p>';
          html += '<ul>';
          html += '<li>La extensi√≥n no se recarg√≥ despu√©s del fix</li>';
          html += '<li>Hay cache de datos antiguos</li>';
          html += '<li>Los datos de la API han cambiado desde tu reporte</li>';
          html += '<li>Hay otro m√©todo de c√°lculo activo</li>';
          html += '</ul>';
          html += '<p><strong>Soluci√≥n:</strong> Recarga la extensi√≥n completamente</p>';
          html += '</div>';
        } else if (consensoAhora > 1450) {
          html += '<div class="success">';
          html += '<h3>‚úÖ FIX FUNCIONANDO</h3>';
          html += `<p>El consenso corregido es $${consensoAhora.toFixed(2)} (>1450) como esperabas.</p>`;
          html += '<p>Si a√∫n ves $1423 en la extensi√≥n, rec√°rgala completamente.</p>';
          html += '</div>';
        } else {
          html += '<div class="info-box">';
          html += '<h3>‚ÑπÔ∏è DATOS INTERMEDIOS</h3>';
          html += `<p>El consenso corregido es $${consensoAhora.toFixed(2)}.</p>`;
          html += '<p>Verifica si este valor coincide con lo que ves en la extensi√≥n.</p>';
          html += '</div>';
        }

        output.innerHTML = html;

      } catch (error) {
        output.innerHTML = `<div class="error">
          <h3>‚ùå Error</h3>
          <p>${error.message}</p>
          <pre>${error.stack}</pre>
        </div>`;
      }
    }

    // Auto-ejecutar
    window.addEventListener('load', () => {
      setTimeout(verificarFix, 500);
    });
  </script>
</body>
</html>