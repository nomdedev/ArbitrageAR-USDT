#!/usr/bin/env node

/**
 * Script para analizar y optimizar el uso de !important en CSS
 * Elimina !important innecesarios pero conserva los cr√≠ticos para animaciones
 */

const fs = require('fs');
const path = require('path');

// Patrones que deben conservar !important
const CRITICAL_IMPORTANT_PATTERNS = [
  /animation:\s*none\s*!important/, // Detener animaciones
  /animation-duration:\s*0\.01ms\s*!important/, // Duraciones m√≠nimas para accesibilidad
  /animation-iteration-count:\s*1\s*!important/, // Iteraciones controladas
  /transition-duration:\s*0\.01ms\s*!important/, // Transiciones m√≠nimas
  /transform:\s*none\s*!important/, // Resetear transformaciones
  /scroll-behavior:\s*auto\s*!important/, // Comportamiento de scroll cr√≠tico
  /display:\s*flex\s*!important/, // Layout cr√≠tico en ciertos contextos
  /color:\s*#[0-9a-fA-F]{6}\s*!important/ // Colores espec√≠ficos para estados
];

// Funci√≥n para analizar y optimizar !important en un archivo
function optimizeImportantUsage(filePath) {
  const content = fs.readFileSync(filePath, 'utf8');
  const lines = content.split('\n');
  
  let modified = false;
  let removedCount = 0;
  let keptCount = 0;
  const newLines = [];
  
  lines.forEach((line, index) => {
    const lineNumber = index + 1;
    let newLine = line;
    
    // Si la l√≠nea contiene !important
    if (line.includes('!important')) {
      // Verificar si es un caso cr√≠tico que debe mantenerse
      let shouldKeep = false;
      
      for (const pattern of CRITICAL_IMPORTANT_PATTERNS) {
        if (pattern.test(line)) {
          shouldKeep = true;
          keptCount++;
          break;
        }
      }
      
      // Si no es cr√≠tico, eliminar !important
      if (!shouldKeep) {
        newLine = line.replace(/\s*!important\s*/g, '');
        removedCount++;
        modified = true;
        
        // Solo mostrar si realmente se elimin√≥ algo
        if (newLine !== line) {
          console.log(`    [L√≠nea ${lineNumber}] Eliminado !important: ${line.trim()}`);
          console.log(`    -> ${newLine.trim()}`);
        }
      } else {
        console.log(`    [L√≠nea ${lineNumber}] Mantenido !important (cr√≠tico): ${line.trim()}`);
      }
    }
    
    newLines.push(newLine);
  });
  
  // Guardar el archivo si se modific√≥
  if (modified) {
    fs.writeFileSync(filePath, newLines.join('\n'), 'utf8');
    console.log(`  ‚úÖ Modificado: ${removedCount} !important eliminados, ${keptCount} mantenidos`);
    return { modified: true, removed: removedCount, kept: keptCount };
  }
  
  return { modified: false, removed: 0, kept: keptCount };
}

// Funci√≥n principal
function main() {
  console.log('üîß Optimizando uso de !important en archivos CSS...\n');
  
  const cssFiles = [
    'src/popup.css',
    'src/options.css',
    'src/base.css',
    'src/ui-components/design-system.css',
    'src/ui-components/animations.css',
    'src/ui-components/arbitrage-panel.css',
    'src/ui-components/exchange-card.css',
    'src/ui-components/header.css',
    'src/ui-components/loading-states.css',
    'src/ui-components/states-feedback.css',
    'src/ui-components/tabs.css'
  ];
  
  let totalModified = 0;
  let totalRemoved = 0;
  let totalKept = 0;
  
  cssFiles.forEach(file => {
    if (fs.existsSync(file)) {
      console.log(`üìÅ Procesando: ${file}`);
      const result = optimizeImportantUsage(file);
      
      if (result.modified) {
        totalModified++;
        totalRemoved += result.removed;
      }
      totalKept += result.kept;
      
      if (!result.modified && result.kept === 0) {
        console.log(`  ‚úÖ Sin uso de !important encontrado`);
      } else if (!result.modified && result.kept > 0) {
        console.log(`  ‚úÖ ${result.kept} !important cr√≠ticos mantenidos (sin cambios necesarios)`);
      }
      console.log('');
    } else {
      console.log(`‚ö†Ô∏è  Archivo no encontrado: ${file}\n`);
    }
  });
  
  console.log(`üìä RESUMEN:`);
  console.log(`Total de archivos procesados: ${cssFiles.length}`);
  console.log(`Archivos modificados: ${totalModified}`);
  console.log(`Total de !important eliminados: ${totalRemoved}`);
  console.log(`Total de !important cr√≠ticos mantenidos: ${totalKept}`);
  console.log('\n‚ú® Optimizaci√≥n completada.');
}

// Ejecutar si se llama directamente
if (require.main === module) {
  main();
}

module.exports = { optimizeImportantUsage };